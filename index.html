<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Indicadores Mejorado</title>

<style>
body{
  font-family:'Segoe UI', Arial, sans-serif;
  background:#f4f6f9;
  margin:0;
  padding:20px;
}
h2{text-align:center;color:#2c3e50;}
input,select,button{
  padding:10px;
  margin:8px 5px;
  border-radius:6px;
  border:1px solid #ccc;
  font-size:12px;
}
button{
  background:#2c3e50;
  color:white;
  border:none;
  cursor:pointer;
}
button:hover{background:#1a252f;}
.controles{text-align:center;margin-bottom:10px;}
.table-container{
  overflow:auto;
  max-height:65vh;
  border-radius:10px;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);
  background:white;
}
table{border-collapse:collapse;width:100%;font-size:12px;}
th{
  background:#34495e;
  color:white;
  padding:10px;
  position:sticky;
  top:0;
  z-index:2;
  cursor:pointer;
}
td{
  padding:8px;
  text-align:center;
  border-bottom:1px solid #eee;
  position:relative;
}
td,th{white-space:nowrap;text-overflow:ellipsis;overflow:hidden;}
th:nth-child(2),td:nth-child(2){min-width:120px;text-align:left;}
tr:nth-child(even){background:#f9fbfd;}
tr:hover{background:#e8f4ff;}
.kpi-verde{background:#d4edda;color:#155724;font-weight:bold;}
.kpi-amarillo{background:#fff3cd;color:#856404;font-weight:bold;}
.kpi-rojo{background:#f8d7da;color:#721c24;font-weight:bold;}
#resumenKPI{
  background:white;
  padding:12px;
  border-radius:10px;
  margin-bottom:10px;
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
  font-size:12px;
}
#fechaActualizacion{
  text-align:center;
  font-weight:bold;
  margin-bottom:10px;
  color:#2c3e50;
}
/* Ocultar columnas 1 y 3 */
th:nth-child(1),td:nth-child(1),
th:nth-child(3),td:nth-child(3){display:none;}
/* Congelar columna 2 */
th:nth-child(2),td:nth-child(2){
  position:sticky;
  left:0;
  background:white;
  z-index:3;
  box-shadow:2px 0 5px rgba(0,0,0,0.1);
}
th:nth-child(2){z-index:4;background:#34495e;}
.barra-kpi{
  height:10px;
  border-radius:5px;
  margin-bottom:2px;
}
</style>
</head>
<body>

<h2>ðŸ“Š Panel de Indicadores Mejorado</h2>
<div id="fechaActualizacion"></div>

<div class="controles">
  <input type="text" id="filtro" placeholder="Buscar...">
  <select id="vista">
    <option value="dia">Vista Diaria</option>
    <option value="semana">Vista Semanal</option>
    <option value="mes">Vista Mensual</option>
  </select>
  <select id="mesFiltro">
    <option value="">Todos los meses</option>
  </select>
  <button id="exportarExcel">ðŸ“¥ Exportar Excel</button>
</div>

<div id="resumenKPI"></div>

<div class="table-container">
  <table>
    <thead></thead>
    <tbody></tbody>
  </table>
</div>

<script>
const url="https://docs.google.com/spreadsheets/d/e/2PACX-1vTv__z4dmUZOol3wAk_xfvxVHrJHFuaP3dKX8M9S-j6dd3WjUz0iCpxGnIOzpq2s1oOKPWGf5q45Yox/pub?output=csv";

function parseCSV(text){
  const rows=[];let r=[],v="",inQuotes=false;
  for(let i=0;i<text.length;i++){
    const c=text[i],n=text[i+1];
    if(c=='"'&&inQuotes&&n=='"'){v+='"';i++;}
    else if(c=='"'){inQuotes=!inQuotes;}
    else if(c==','&&!inQuotes){r.push(v);v="";}
    else if((c=='\n'||c=='\r')&&!inQuotes){if(v||r.length){r.push(v);rows.push(r);}r=[];v="";}
    else v+=c;
  }
  if(v||r.length){r.push(v);rows.push(r);}
  return rows;
}

fetch(url)
.then(r=>r.text())
.then(csv=>{

const filas=parseCSV(csv);
const encabezados=filas[0];
const datos=filas.slice(1);

const IDX={
  DIA:encabezados.indexOf("DIA"),
  SEMANA:encabezados.indexOf("SEMANA"),
  MES:encabezados.indexOf("MES")
};

const thead=document.querySelector("thead");
const tbody=document.querySelector("tbody");

thead.innerHTML="<tr>"+encabezados.map(h=>`<th data-col="${h}">${h}</th>`).join("")+"</tr>";

const mesSel=document.getElementById("mesFiltro");
[...new Set(datos.map(f=>f[IDX.MES]))].forEach(m=>{
  if(!m)return;
  const o=document.createElement("option");
  o.value=o.textContent=m;
  mesSel.appendChild(o);
});

function render(filtrado){
  tbody.innerHTML="";
  const frag=document.createDocumentFragment();
  filtrado.forEach(f=>{
    const tr=document.createElement("tr");
    f.forEach((c,i)=>{
      const td=document.createElement("td");
      td.textContent=c;
      tr.appendChild(td);
    });
    frag.appendChild(tr);
  });
  tbody.appendChild(frag);
}

function aplicarFiltros(){
  const t=filtro.value.toLowerCase();
  const v=vistaSel.value;
  const m=mesSel.value;
  render(datos.filter(f=>{
    if(m&&f[IDX.MES]!==m)return false;
    if(v==="semana"&&!f[IDX.SEMANA].includes("Total Semana"))return false;
    if(v==="mes"&&!f[IDX.MES].includes("Total"))return false;
    if(v==="dia"){
      if(!f[IDX.DIA]||
      f[IDX.DIA].toLowerCase().includes("total")||
      f[IDX.SEMANA]?.toLowerCase().includes("total")||
      f[IDX.MES]?.toLowerCase().includes("total"))return false;
    }
    return f.join(" ").toLowerCase().includes(t);
  }));
}

function debounce(fn,d=300){
  let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),d);}
}

const filtro=document.getElementById("filtro");
const vistaSel=document.getElementById("vista");

filtro.addEventListener("keyup",debounce(aplicarFiltros));
vistaSel.addEventListener("change",aplicarFiltros);
mesSel.addEventListener("change",aplicarFiltros);

aplicarFiltros();

/* ===== EXPORTAR ULTRA LIGERO ===== */
document.getElementById("exportarExcel").addEventListener("click",()=>{

  const filasVisibles=[...tbody.querySelectorAll("tr")];
  if(!filasVisibles.length){
    alert("No hay datos para exportar");
    return;
  }

  let csv="";

  const headers=encabezados.filter((_,i)=>i!==0&&i!==2);
  csv+=headers.join(";")+"\n";

  filasVisibles.forEach(tr=>{
    const fila=[...tr.querySelectorAll("td")]
      .filter((_,i)=>i!==0&&i!==2)
      .map(td=>{
        let val=td.innerText.trim();
        if(val.includes("%")){
          val=parseFloat(val.replace("%",""))/100;
        }
        return val;
      });
    csv+=fila.join(";")+"\n";
  });

  const blob=new Blob(["\ufeff"+csv],{type:"text/csv;charset=utf-8;"});
  const urlBlob=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=urlBlob;
  a.download="Panel_Indicadores.xlsx";
  a.click();
  URL.revokeObjectURL(urlBlob);

});

});
</script>
</body>
</html>
