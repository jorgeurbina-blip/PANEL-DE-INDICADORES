<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Indicadores Interactivo</title>

<style>
body{
  font-family: 'Segoe UI', Arial, sans-serif;
  background:#f4f6f9;
  margin:0;
  padding:20px;
}
h2{text-align:center;color:#2c3e50;}
input,select{padding:10px;margin:8px 5px;border-radius:6px;border:1px solid #ccc;}
.controles{text-align:center;margin-bottom:10px;}
.table-container{overflow:auto;max-height:50vh;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.1);background:white;}
table{border-collapse:collapse;width:100%;font-size:12px;transition: all 0.3s;}
th{background:#34495e;color:white;padding:10px;position:sticky;top:0;z-index:2;cursor:pointer;}
td{padding:8px;text-align:center;border-bottom:1px solid #eee;position:relative;transition: all 0.3s;}
td, th {white-space: nowrap;text-overflow: ellipsis; overflow: hidden;}
th:nth-child(2), td:nth-child(2) {min-width: 120px;text-align:left;}
tr:nth-child(even){background:#f9fbfd;}
tr:hover{background:#e8f4ff;}
tr.selected{background:#cce5ff !important;}
.kpi-verde{background:#d4edda;color:#155724;font-weight:bold;}
.kpi-amarillo{background:#fff3cd;color:#856404;font-weight:bold;}
.kpi-rojo{background:#f8d7da;color:#721c24;font-weight:bold;}
#resumenKPI{background:white;padding:12px;border-radius:10px;margin-bottom:10px;box-shadow:0 4px 10px rgba(0,0,0,0.1);font-size:12px;}
#fechaActualizacion{text-align:center;font-weight:bold;margin-bottom:10px;color:#2c3e50;}
th:nth-child(1),td:nth-child(1),th:nth-child(3),td:nth-child(3){display:none;}
th:nth-child(2),td:nth-child(2){position: sticky;left: 0;background: white;z-index: 3;box-shadow: 2px 0 5px rgba(0,0,0,0.1);}
th:nth-child(2){z-index: 4;background: #34495e;}
.barra-kpi{height:10px;border-radius:5px;margin-bottom:2px;transition: width 0.5s;}
td[data-tooltip]:hover::after{
  content: attr(data-tooltip);
  position:absolute;
  top:-25px; left:50%;
  transform:translateX(-50%);
  background:#333;color:#fff;
  padding:3px 6px;border-radius:4px;font-size:10px;white-space: nowrap;z-index:10;
}
#graficosRAC{background:white;padding:10px;margin-bottom:10px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.1);}
canvas{max-width:100%;height:80px;}

tr.selected {
  background: #cce5ff !important;
}  
  
</style>
</head>
<body>

<h2>üìä Panel de Indicadores Interactivo</h2>
<div id="fechaActualizacion"></div>

<div class="controles">
  <input type="text" id="filtro" placeholder="Buscar...">
  <select id="vista">
    <option value="dia">Vista Diaria</option>
    <option value="semana">Vista Semanal</option>
    <option value="mes">Vista Mensual</option>
  </select>
  <select id="mesFiltro"><option value="">Todos los meses</option></select>
</div>

<div id="graficosRAC">
  <strong>Selecciona un RAC para ver su tendencia:</strong>
  <canvas id="graficoRAC"></canvas>
</div>

<div class="table-container">
  <table>
    <thead></thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
<script>
const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTv__z4dmUZOol3wAk_xfvxVHrJHFuaP3dKX8M9S-j6dd3WjUz0iCpxGnIOzpq2s1oOKPWGf5q45Yox/pub?output=csv";

/* ===== CSV Parser ===== */
function parseCSV(text){
  const rows=[], r=[], v="", inQuotes=false;
  let val="", inside=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(c === '"' && inside && n === '"'){val+='"'; i++;} 
    else if(c === '"'){inside=!inside;} 
    else if(c === ',' && !inside){r.push(val); val="";} 
    else if((c=='\n'||c=='\r')&&!inside){if(val||r.length){r.push(val);rows.push(r);} r=[]; val="";} 
    else val+=c;
  }
  if(val||r.length){r.push(val);rows.push(r);}
  return rows;
}

fetch(url)
.then(r=>r.text())
.then(csv=>{
  const filas=parseCSV(csv);
  const encabezados=filas[0];
  const datos=filas.slice(1);

  const IDX={
    DIA:encabezados.indexOf("DIA"),
    SEMANA:encabezados.indexOf("SEMANA"),
    MES:encabezados.indexOf("MES"),
    RAC:encabezados.indexOf("RAC"),
  };

  function parseFechaLatam(fechaStr){
    if(!fechaStr) return null;
    const partes=fechaStr.includes("/")?fechaStr.split("/"):fechaStr.split("-");
    if(partes.length!==3) return null;
    return new Date(parseInt(partes[2],10), parseInt(partes[1],10)-1, parseInt(partes[0],10));
  }

  const fechas = datos.map(f=>f[IDX.DIA]).filter(f=>f && !f.toLowerCase().includes("total")).map(parseFechaLatam).filter(f=>f instanceof Date && !isNaN(f));
  const fechaMax = new Date(Math.max(...fechas));
  document.getElementById("fechaActualizacion").textContent = `DATOS ACTUALIZADOS AL D√çA ${fechaMax.toLocaleDateString("es-CL")}`;

  const thead=document.querySelector("thead");
  const tbody=document.querySelector("tbody");
  thead.innerHTML="<tr>"+encabezados.map(h=>`<th data-col="${h}">${h}</th>`).join("")+"</tr>";

  // Meses din√°micos
  const mesSel=document.getElementById("mesFiltro");
  [...new Set(datos.map(f=>f[IDX.MES]))].forEach(m=>{
    if(!m) return;
    const o=document.createElement("option");
    o.value=o.textContent=m;
    mesSel.appendChild(o);
  });

  const reglasKPI={
    "% FCR 1dia":90,"%FCR 7dia":90,"% Adher General":80,"% Descto":80,"% Rein.":5,"% Ef. BAF":80,
    "% Argumentario":23,"% Oferta":80,"% Adh Capl":25,"%adh Oferta 0":20,"%adh Oferta 1":12,"%adh Oferta 2":23,
    "%adh Oferta 3":55,"% VS Atendidas":90,"% Baja Parc.":4,"% Short Call":5,"% Transf.":10,"% Baja Parc. IPTV":4,"% Corte rac":1
  };
  const reglasInvertidas=["% Short Call","% Transf.","% Adh Capl","% Rein.","%adh Oferta 0","% Baja Parc.","% Argumentario","%adh Oferta 1","%adh Oferta 2","%adh Oferta 3","% Baja Parc. IPTV","% Corte rac"];

  function reglaPorColumna(h,v){
    if(!v.includes("%")) return "";
    const n=parseFloat(v.replace("%",""));
    if(isNaN(n)) return "";
    const meta=reglasKPI[h]??85;
    if(reglasInvertidas.includes(h)){
      if(n<=meta) return "kpi-verde";
      if(n<=meta+5) return "kpi-amarillo";
      return "kpi-rojo";
    }
    if(n>=meta) return "kpi-verde";
    if(n>=meta-10) return "kpi-amarillo";
    return "kpi-rojo";
  }

  function render(filtrado){
    tbody.innerHTML="";
    const frag=document.createDocumentFragment();
    filtrado.forEach(f=>{
      const tr=document.createElement("tr");
      f.forEach((c,i)=>{
        const td=document.createElement("td");
        const kpiClass=reglaPorColumna(encabezados[i],c);
        td.className=kpiClass;
        if(c.includes("%")){
          const n=parseFloat(c.replace("%",""));
          const bar=document.createElement("div");
          bar.className="barra-kpi";
          bar.style.width=n+"%";
          bar.style.background=kpiClass==="kpi-verde"?"#28a745":kpiClass==="kpi-amarillo"?"#ffc107":"#dc3545";
          td.appendChild(bar);
          td.appendChild(document.createTextNode(c));
          td.setAttribute("data-tooltip",`Meta: ${reglasKPI[encabezados[i]]||85}%`);
        }else{
          td.textContent=c;
        }
        tr.appendChild(td);
      });
      frag.appendChild(tr);
    });
    tbody.appendChild(frag);
  }

  function aplicarFiltros(){
    const t=filtro.value.toLowerCase();
    const v=vistaSel.value;
    const m=mesSel.value;
    render(datos.filter(f=>{
      if(m && f[IDX.MES]!==m) return false;
      if(v==="dia"){if(!f[IDX.DIA] || f[IDX.DIA].toLowerCase().includes("total") || f[IDX.SEMANA]?.toLowerCase().includes("total") || f[IDX.MES]?.toLowerCase().includes("total")) return false;}
      if(v==="semana" && !f[IDX.SEMANA].includes("Total Semana")) return false;
      if(v==="mes" && !f[IDX.MES].includes("Total")) return false;
      return f.join(" ").toLowerCase().includes(t);
    }));
  }

  function debounce(fn,d=300){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),d);};}

  const filtro=document.getElementById("filtro");
  const vistaSel=document.getElementById("vista");
  filtro.addEventListener("keyup",debounce(aplicarFiltros));
  vistaSel.addEventListener("change",aplicarFiltros);
  mesSel.addEventListener("change",aplicarFiltros);
  aplicarFiltros();

  document.querySelectorAll("th").forEach(th=>{
    th.addEventListener("click",()=>{
      const col=th.getAttribute("data-col");
      const idx=encabezados.indexOf(col);
      datos.sort((a,b)=>{
        const valA=a[idx].replace("%",""); const valB=b[idx].replace("%","");
        return (!isNaN(parseFloat(valA))?parseFloat(valA):valA) - (!isNaN(parseFloat(valB))?parseFloat(valB):valB);
      });
      aplicarFiltros();
    });
  });

  /* ===== GRAFICO POR RAC Y COLUMNA ===== */
  const canvasGrafico=document.getElementById("graficoRAC");
  const ctx = canvasGrafico.getContext("2d");
  let grafico;

  tbody.addEventListener("click", e=>{
    const td=e.target.closest("td");
    const tr=e.target.closest("tr");
    if(!td || !tr) return;
    const colIdx=Array.from(tr.children).indexOf(td);
    if(colIdx<=IDX.RAC) return; // Solo columnas desde reciencia hacia adelante
    const rac = tr.children[IDX.RAC].textContent.trim();
    const kpiName = encabezados[colIdx];
    const vista = vistaSel.value;

    // Filtrar seg√∫n vista
    const datosFiltrados = datos.filter(f=>{
      if(f[IDX.RAC] !== rac) return false;
      if(vista==="dia") return f[IDX.DIA] && !/total/i.test(f[IDX.DIA].toLowerCase());
      if(vista==="semana") return f[IDX.SEMANA] && /total semana/i.test(f[IDX.SEMANA].toLowerCase());
      if(vista==="mes") return f[IDX.MES] && /total/i.test(f[IDX.MES].toLowerCase());
      return false;
    });

    const keyFecha = vista==="dia"?IDX.DIA:(vista==="semana"?IDX.SEMANA:IDX.MES);
    const valores = datosFiltrados.map(f=>{
      let valStr = f[colIdx].replace("%","").replace(",",".");
      let valNum = parseFloat(valStr);
      if(isNaN(valNum)) return null;
      return {fecha:f[keyFecha], valNum};
    }).filter(v=>v!==null);

    valores.sort((a,b)=>{
      if(vista==="dia") return parseFechaLatam(a.fecha)-parseFechaLatam(b.fecha);
      return a.fecha.localeCompare(b.fecha);
    });

    if(grafico) grafico.destroy();
    grafico = new Chart(ctx,{
      type:'line',
      data:{
        labels:valores.map(v=>v.fecha),
        datasets:[{
          label:`${kpiName} - ${rac}`,
          data:valores.map(v=>v.valNum),
          fill:false,
          borderColor:'rgb(54,162,235)',
          tension:0.3,
          pointRadius:4,
          pointHoverRadius:6,
          borderWidth:3
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{legend:{display:true}},
        scales:{y:{beginAtZero:true}}
      }
    });

    // Marcar fila seleccionada
    tbody.querySelectorAll("tr").forEach(row=>row.classList.remove("selected"));
    tr.classList.add("selected");
  });

});
<!-- Agregar esto justo antes de cerrar </body> -->
<div id="graficosRAC" style="background:white;padding:10px;margin-bottom:10px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.1);">
  <strong>üìà Tendencia del RAC seleccionado:</strong>
  <canvas id="graficoRAC"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const canvasRAC = document.getElementById("graficoRAC");
const ctxRAC = canvasRAC.getContext("2d");
let graficoRAC;

function mostrarGraficoRAC(rac, vista) {
  const idxRAC = encabezados.indexOf("RAC");
  const idxInicio = encabezados.indexOf("REICIENCIA"); // Ajusta seg√∫n nombre exacto
  if(idxInicio === -1) return;

  // Filtrar datos seg√∫n RAC y vista
  const datosFiltrados = datos.filter(f => {
    if(f[idxRAC] !== rac) return false;
    if(vista==="dia") return f[IDX.DIA] && !/total/i.test(f[IDX.DIA].toLowerCase());
    if(vista==="semana") return f[IDX.SEMANA] && /total semana/i.test(f[IDX.SEMANA].toLowerCase());
    if(vista==="mes") return f[IDX.MES] && /total/i.test(f[IDX.MES].toLowerCase());
    return false;
  });

  if(datosFiltrados.length === 0){
    if(graficoRAC) graficoRAC.destroy();
    ctxRAC.clearRect(0,0,canvasRAC.width,canvasRAC.height);
    ctxRAC.font="16px Arial";
    ctxRAC.fillText(`No hay datos para ${rac}`,10,50);
    return;
  }

  // Preparar datasets para todas las columnas desde REICIENCIA
  const datasets = [];
  for(let i=idxInicio; i<encabezados.length; i++){
    const col = encabezados[i];
    const valores = datosFiltrados.map(f=>{
      const valStr = f[i].replace("%","").replace(",",".");
      const valNum = parseFloat(valStr);
      return isNaN(valNum) ? null : valNum;
    });
    if(valores.every(v=>v===null)) continue; // Ignorar columnas sin datos
    datasets.push({
      label: col,
      data: valores,
      borderColor: `hsl(${Math.random()*360},70%,50%)`,
      fill: false,
      tension: 0.3,
      pointRadius: 4,
      pointHoverRadius: 6,
      borderWidth: 2
    });
  }

  const labels = datosFiltrados.map(f=>{
    if(vista==="dia") return f[IDX.DIA];
    if(vista==="semana") return f[IDX.SEMANA];
    if(vista==="mes") return f[IDX.MES];
    return "";
  });

  if(graficoRAC) graficoRAC.destroy();
  graficoRAC = new Chart(ctxRAC,{
    type:'line',
    data:{labels,datasets},
    options:{
      responsive:true,
      plugins:{legend:{display:true}},
      scales:{y:{beginAtZero:true}}
    }
  });
}

// Evento click en fila de tabla
tbody.addEventListener("click", e=>{
  const tr = e.target.closest("tr");
  if(!tr) return;
  const celdas = tr.querySelectorAll("td");
  const rac = celdas[encabezados.indexOf("RAC")].textContent.trim();
  if(!rac) return;
  mostrarGraficoRAC(rac, vistaSel.value);

  // Marcar fila seleccionada
  tbody.querySelectorAll("tr").forEach(row=>row.classList.remove("selected"));
  tr.classList.add("selected");
});



</script>
</body>
</html>





