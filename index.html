<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Indicadores Interactivo</title>

<style>
body{
  font-family: 'Segoe UI', Arial, sans-serif;
  background:#f4f6f9;
  margin:0;
  padding:20px;
}
h2{text-align:center;color:#2c3e50;}
input,select{padding:10px;margin:8px 5px;border-radius:6px;border:1px solid #ccc;}
.controles{text-align:center;margin-bottom:10px;}
.table-container{overflow:auto;max-height:50vh;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.1);background:white;}
table{border-collapse:collapse;width:100%;font-size:12px;transition: all 0.3s;}
th{background:#34495e;color:white;padding:10px;position:sticky;top:0;z-index:2;cursor:pointer;}
td{padding:8px;text-align:center;border-bottom:1px solid #eee;position:relative;transition: all 0.3s;}
td, th {white-space: nowrap;text-overflow: ellipsis; overflow: hidden;}
th:nth-child(2), td:nth-child(2) {min-width: 120px;text-align:left;}
tr:nth-child(even){background:#f9fbfd;}
tr:hover{background:#e8f4ff;}
tr.selected{background:#cce5ff !important;}
.kpi-verde{background:#d4edda;color:#155724;font-weight:bold;}
.kpi-amarillo{background:#fff3cd;color:#856404;font-weight:bold;}
.kpi-rojo{background:#f8d7da;color:#721c24;font-weight:bold;}
#resumenKPI{background:white;padding:12px;border-radius:10px;margin-bottom:10px;box-shadow:0 4px 10px rgba(0,0,0,0.1);font-size:12px;}
#fechaActualizacion{text-align:center;font-weight:bold;margin-bottom:10px;color:#2c3e50;}
th:nth-child(1),td:nth-child(1),th:nth-child(3),td:nth-child(3){display:none;}
th:nth-child(2),td:nth-child(2){position: sticky;left: 0;background: white;z-index: 3;box-shadow: 2px 0 5px rgba(0,0,0,0.1);}
th:nth-child(2){z-index: 4;background: #34495e;}
.barra-kpi{height:10px;border-radius:5px;margin-bottom:2px;transition: width 0.5s;}
td[data-tooltip]:hover::after{
  content: attr(data-tooltip);
  position:absolute;
  top:-25px; left:50%;
  transform:translateX(-50%);
  background:#333;color:#fff;
  padding:3px 6px;border-radius:4px;font-size:10px;white-space: nowrap;z-index:10;
}
#graficosRAC{background:white;padding:10px;margin-bottom:10px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.1);}
canvas{max-width:100%;height:80px;}
</style>
</head>
<body>

<h2>游늵 Panel de Indicadores Interactivo</h2>
<div id="fechaActualizacion"></div>

<div class="controles">
  <input type="text" id="filtro" placeholder="Buscar...">
  <select id="vista">
    <option value="dia">Vista Diaria</option>
    <option value="semana">Vista Semanal</option>
    <option value="mes">Vista Mensual</option>
  </select>
  <select id="mesFiltro"><option value="">Todos los meses</option></select>
</div>

<div id="graficosRAC">
  <strong>Selecciona un RAC para ver su tendencia:</strong>
  <canvas id="graficoRAC"></canvas>
</div>

<div class="table-container">
  <table>
    <thead></thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTv__z4dmUZOol3wAk_xfvxVHrJHFuaP3dKX8M9S-j6dd3WjUz0iCpxGnIOzpq2s1oOKPWGf5q45Yox/pub?output=csv";

// Mejor parseador CSV robusto:
function parseCSV(text) {
  const lines = text.trim().split(/\r?\n/);
  return lines.map(line => {
    // Para manejar comillas dobles y comas dentro de campos
    const regex = /("([^"]|"")*"|[^,]*)(,|$)/g;
    let match, row = [];
    while ((match = regex.exec(line)) !== null) {
      let val = match[1];
      if(val.startsWith('"') && val.endsWith('"')){
        val = val.slice(1, -1).replace(/""/g, '"');
      }
      row.push(val);
      if(match[3] === "") break;
    }
    return row;
  });
}

fetch(url)
.then(r => r.text())
.then(csv => {
  const filas = parseCSV(csv);
  if(filas.length === 0){
    console.error("CSV vac칤o o mal cargado");
    return;
  }
  const encabezados = filas[0];
  const datos = filas.slice(1);

  console.log("Encabezados:", encabezados);
  console.log("Primeros datos:", datos.slice(0,3));

  const IDX = {
    DIA: encabezados.indexOf("DIA"),
    SEMANA: encabezados.indexOf("SEMANA"),
    MES: encabezados.indexOf("MES")
  };

  console.log("칈ndices:", IDX);

  if(IDX.DIA === -1 || IDX.SEMANA === -1 || IDX.MES === -1){
    console.error("Columnas DIA, SEMANA o MES no encontradas, revisar CSV");
    return;
  }

  // Funci칩n fecha latam simplificada
  function parseFechaLatam(fechaStr) {
    if(!fechaStr) return null;
    const partes = fechaStr.includes("/") ? fechaStr.split("/") : fechaStr.split("-");
    if(partes.length !== 3) return null;
    const dia = parseInt(partes[0],10);
    const mes = parseInt(partes[1],10)-1;
    const anio = parseInt(partes[2],10);
    return new Date(anio, mes, dia);
  }

  // Calcular fecha m치xima de actualizaci칩n
  const fechas = datos
    .map(f => f[IDX.DIA])
    .filter(f => f && !f.toLowerCase().includes("total"))
    .map(parseFechaLatam)
    .filter(f => f instanceof Date && !isNaN(f));

  const fechaMax = new Date(Math.max(...fechas));
  document.getElementById("fechaActualizacion").textContent =
    `DATOS ACTUALIZADOS AL D칈A ${fechaMax.toLocaleDateString("es-CL")}`;

  const thead = document.querySelector("thead");
  const tbody = document.querySelector("tbody");
  thead.innerHTML = "<tr>" + encabezados.map(h => `<th>${h}</th>`).join("") + "</tr>";

  // Cargar meses din치micos
  const mesSel = document.getElementById("mesFiltro");
  [...new Set(datos.map(f => f[IDX.MES]).filter(m => m))].forEach(m => {
    const option = document.createElement("option");
    option.value = option.textContent = m;
    mesSel.appendChild(option);
  });

  function render(filtrado) {
    tbody.innerHTML = "";
    if(filtrado.length === 0){
      tbody.innerHTML = "<tr><td colspan='"+encabezados.length+"' style='text-align:center;color:#888'>No hay datos para mostrar</td></tr>";
      return;
    }
    filtrado.forEach(fila => {
      const tr = document.createElement("tr");
      fila.forEach(c => {
        const td = document.createElement("td");
        td.textContent = c;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  function aplicarFiltros() {
    const t = document.getElementById("filtro").value.toLowerCase();
    const v = document.getElementById("vista").value;
    const m = mesSel.value;

    // Para debug:
    console.log(`Filtrando con texto: "${t}", vista: "${v}", mes: "${m}"`);

    const filtrado = datos.filter(f => {
      if(m && f[IDX.MES] !== m) return false;
      // COMENTAMOS temporalmente filtro por vista para probar datos:
      /*
      if(v === "dia"){
        if(!f[IDX.DIA] || f[IDX.DIA].toLowerCase().includes("total")) return false;
      }
      if(v === "semana" && !f[IDX.SEMANA].includes("Total Semana")) return false;
      if(v === "mes" && !f[IDX.MES].includes("Total")) return false;
      */
      return f.join(" ").toLowerCase().includes(t);
    });
    console.log("Datos filtrados:", filtrado.length);
    render(filtrado);
  }

  document.getElementById("filtro").addEventListener("input", aplicarFiltros);
  document.getElementById("vista").addEventListener("change", aplicarFiltros);
  mesSel.addEventListener("change", aplicarFiltros);

  aplicarFiltros();
})
.catch(e => console.error("Error cargando CSV:", e));

</script>
</body>
</html>

