<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Indicadores Mejorado</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
/* TU MISMO CSS (no se modifica diseÃ±o original) */
body{font-family:'Segoe UI',Arial,sans-serif;background:#f4f6f9;margin:0;padding:20px;}
h2{text-align:center;color:#2c3e50;}
input,select,button{padding:10px;margin:8px 5px;border-radius:6px;border:1px solid #ccc;}
button{background:#2c3e50;color:white;font-weight:bold;cursor:pointer;border:none;}
button:hover{background:#1a252f;}
.controles{text-align:center;margin-bottom:10px;}
.table-container{overflow:auto;max-height:65vh;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.1);background:white;}
table{border-collapse:collapse;width:100%;font-size:12px;}
th{background:#34495e;color:white;padding:10px;position:sticky;top:0;cursor:pointer;}
td{padding:8px;text-align:center;border-bottom:1px solid #eee;}
.kpi-verde{background:#d4edda;color:#155724;font-weight:bold;}
.kpi-amarillo{background:#fff3cd;color:#856404;font-weight:bold;}
.kpi-rojo{background:#f8d7da;color:#721c24;font-weight:bold;}
th:nth-child(1),td:nth-child(1),th:nth-child(3),td:nth-child(3){display:none;}
</style>
</head>
<body>

<h2>ðŸ“Š Panel de Indicadores Mejorado</h2>
<div id="fechaActualizacion"></div>

<div class="controles">
<input type="text" id="filtro" placeholder="Buscar...">
<select id="vista">
<option value="dia">Vista Diaria</option>
<option value="semana">Vista Semanal</option>
<option value="mes">Vista Mensual</option>
</select>
<select id="mesFiltro"><option value="">Todos los meses</option></select>
<button id="exportarExcel">ðŸ“Š Exportar Excel Ejecutivo</button>
</div>

<div class="table-container">
<table>
<thead></thead>
<tbody></tbody>
</table>
</div>

<script>
const url="https://docs.google.com/spreadsheets/d/e/2PACX-1vTv__z4dmUZOol3wAk_xfvxVHrJHFuaP3dKX8M9S-j6dd3WjUz0iCpxGnIOzpq2s1oOKPWGf5q45Yox/pub?output=csv";

let datosFiltradosGlobal=[];
let encabezadosGlobal=[];

function parseCSV(text){
let rows=[],r=[],v="",inQuotes=false;
for(let i=0;i<text.length;i++){
const c=text[i],n=text[i+1];
if(c=='"'&&inQuotes&&n=='"'){v+='"';i++;}
else if(c=='"'){inQuotes=!inQuotes;}
else if(c==','&&!inQuotes){r.push(v);v="";}
else if((c=='\n'||c=='\r')&&!inQuotes){if(v||r.length){r.push(v);rows.push(r);}r=[];v="";}
else v+=c;
}
if(v||r.length){r.push(v);rows.push(r);}
return rows;
}

fetch(url)
.then(r=>r.text())
.then(csv=>{

const filas=parseCSV(csv);
const encabezados=filas[0];
encabezadosGlobal=encabezados;
const datos=filas.slice(1);

const IDX={DIA:encabezados.indexOf("DIA"),SEMANA:encabezados.indexOf("SEMANA"),MES:encabezados.indexOf("MES")};

const thead=document.querySelector("thead");
const tbody=document.querySelector("tbody");

thead.innerHTML="<tr>"+encabezados.map(h=>`<th>${h}</th>`).join("")+"</tr>";

function render(filtrado){
datosFiltradosGlobal=filtrado;
tbody.innerHTML="";
filtrado.forEach(f=>{
const tr=document.createElement("tr");
f.forEach(c=>{
const td=document.createElement("td");
td.textContent=c;
tr.appendChild(td);
});
tbody.appendChild(tr);
});
}

function aplicarFiltros(){
const t=filtro.value.toLowerCase();
const v=vista.value;
const m=mesFiltro.value;
render(datos.filter(f=>{
if(m&&f[IDX.MES]!==m)return false;
return f.join(" ").toLowerCase().includes(t);
}));
}

filtro.addEventListener("keyup",aplicarFiltros);
vista.addEventListener("change",aplicarFiltros);
mesFiltro.addEventListener("change",aplicarFiltros);
aplicarFiltros();

/* ===============================
   EXPORTAR EXCEL EJECUTIVO PRO
==================================*/

document.getElementById("exportarExcel").addEventListener("click",()=>{

if(datosFiltradosGlobal.length===0){
alert("No hay datos");
return;
}

const columnasOcultas=[0,2];
const encabezadosVisibles=encabezadosGlobal.filter((_,i)=>!columnasOcultas.includes(i));
const datosVisibles=datosFiltradosGlobal.map(f=>f.filter((_,i)=>!columnasOcultas.includes(i)));

const wb=XLSX.utils.book_new();

/* ===== HOJA 1: DETALLE CON COLORES ===== */
const ws=XLSX.utils.aoa_to_sheet([encabezadosVisibles,...datosVisibles]);

// Congelar columna RAC
ws["!freeze"]={xSplit:1,ySplit:1};

// Colores KPI
datosVisibles.forEach((row,r)=>{
row.forEach((cell,c)=>{
if(cell.includes("%")){
const val=parseFloat(cell.replace("%",""));
const ref=XLSX.utils.encode_cell({r:r+1,c:c});
if(!ws[ref])return;
if(val>=90)ws[ref].s={fill:{fgColor:{rgb:"C6EFCE"}}};
else if(val>=80)ws[ref].s={fill:{fgColor:{rgb:"FFEB9C"}}};
else ws[ref].s={fill:{fgColor:{rgb:"FFC7CE"}}};
}
});
});

XLSX.utils.book_append_sheet(wb,ws,"Detalle KPI");

/* ===== HOJA 2: RESUMEN AUTOMATICO ===== */

const columnasKPIs=encabezadosVisibles.filter(h=>h.includes("%"));
const resumenData=[["KPI","Promedio %"]];

columnasKPIs.forEach((kpi)=>{
let idx=encabezadosVisibles.indexOf(kpi);
let valores=datosVisibles.map(r=>parseFloat(r[idx]?.replace("%",""))||0);
let promedio=(valores.reduce((a,b)=>a+b,0)/valores.length)||0;
resumenData.push([kpi,Number(promedio.toFixed(2))]);
});

const wsResumen=XLSX.utils.aoa_to_sheet(resumenData);

// Formato %
for(let i=1;i<resumenData.length;i++){
const ref="B"+(i+1);
if(wsResumen[ref])wsResumen[ref].z="0.00%";
}

XLSX.utils.book_append_sheet(wb,wsResumen,"Resumen KPI");

/* ===== NOMBRE ARCHIVO CON FECHA ===== */

const hoy=new Date();
const nombre=`Indicadores_Ejecutivo_${hoy.toISOString().split("T")[0]}.xlsx`;

XLSX.writeFile(wb,nombre);

});

});
</script>
</body>
</html>
