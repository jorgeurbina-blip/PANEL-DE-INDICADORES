<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Indicadores Mejorado</title>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{
  font-family: 'Segoe UI', Arial, sans-serif;
  background:#f4f6f9;
  margin:0;
  padding:20px;
}
h2{text-align:center;color:#2c3e50;}
input,select,button{padding:10px;margin:8px 5px;border-radius:6px;border:1px solid #ccc;}
button{background:#2c3e50;color:white;font-weight:bold;cursor:pointer;border:none;}
button:hover{background:#1a252f;}
.controles{text-align:center;margin-bottom:10px;}
.table-container{overflow:auto;max-height:65vh;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.1);background:white;}
table{border-collapse:collapse;width:100%;font-size:12px;transition: all 0.3s;}
th{background:#34495e;color:white;padding:10px;position:sticky;top:0;z-index:2;cursor:pointer;}
td{padding:8px;text-align:center;border-bottom:1px solid #eee;position:relative;transition: all 0.3s;}
td, th {white-space: nowrap;text-overflow: ellipsis; overflow: hidden;}
th:nth-child(2), td:nth-child(2) {min-width: 120px;text-align:left;}
tr:nth-child(even){background:#f9fbfd;}
tr:hover{background:#e8f4ff;}
.kpi-verde{background:#d4edda;color:#155724;font-weight:bold;}
.kpi-amarillo{background:#fff3cd;color:#856404;font-weight:bold;}
.kpi-rojo{background:#f8d7da;color:#721c24;font-weight:bold;}
#resumenKPI{background:white;padding:12px;border-radius:10px;margin-bottom:10px;box-shadow:0 4px 10px rgba(0,0,0,0.1);font-size:12px;}
#fechaActualizacion{text-align:center;font-weight:bold;margin-bottom:10px;color:#2c3e50;}
th:nth-child(1),td:nth-child(1),th:nth-child(3),td:nth-child(3){display:none;}
th:nth-child(2),td:nth-child(2){
  position: sticky;
  left: 0;
  background: white;
  z-index: 3;
  box-shadow: 2px 0 5px rgba(0,0,0,0.1);
}
th:nth-child(2){z-index: 4;background: #34495e;}
.barra-kpi{height:10px;border-radius:5px;margin-bottom:2px;}
</style>
</head>
<body>

<h2>üìä Panel de Indicadores Mejorado</h2>
<div id="fechaActualizacion"></div>

<div class="controles">
  <input type="text" id="filtro" placeholder="Buscar...">
  <select id="vista">
    <option value="dia">Vista Diaria</option>
    <option value="semana">Vista Semanal</option>
    <option value="mes">Vista Mensual</option>
  </select>
  <select id="mesFiltro"><option value="">Todos los meses</option></select>
  <button id="exportarExcel">üìä Exportar Excel Ejecutivo</button>
</div>

<div id="resumenKPI"></div>

<div class="table-container">
  <table>
    <thead></thead>
    <tbody></tbody>
  </table>
</div>

<script>
const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTv__z4dmUZOol3wAk_xfvxVHrJHFuaP3dKX8M9S-j6dd3WjUz0iCpxGnIOzpq2s1oOKPWGf5q45Yox/pub?output=csv";

let datosFiltradosGlobal=[];
let encabezadosGlobal=[];
let reglasKPIGlobal={};
let reglasInvertidasGlobal=[];

/* ===== CSV Parser ===== */
function parseCSV(text){
  const rows=[]; let r=[], v="", inQuotes=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(c === '"' && inQuotes && n === '"'){v+='"'; i++;} 
    else if(c === '"'){inQuotes=!inQuotes;} 
    else if(c === ',' && !inQuotes){r.push(v);v="";} 
    else if((c=='\n'||c=='\r')&&!inQuotes){if(v||r.length){r.push(v);rows.push(r);} r=[];v="";} 
    else v+=c;
  }
  if(v||r.length){r.push(v);rows.push(r);}
  return rows;
}

fetch(url)
.then(r=>r.text())
.then(csv=>{

  const filas=parseCSV(csv);
  const encabezados=filas[0];
  encabezadosGlobal=encabezados;
  const datos=filas.slice(1);

  const IDX={DIA:encabezados.indexOf("DIA"),SEMANA:encabezados.indexOf("SEMANA"),MES:encabezados.indexOf("MES")};

  const fechas = datos.map(f=>f[IDX.DIA]).filter(f=>f && !f.toLowerCase().includes("total")).map(f=>{
    const p=f.split("/");
    return new Date(p[2],p[1]-1,p[0]);
  });
  const fechaMax = new Date(Math.max(...fechas));
  document.getElementById("fechaActualizacion").textContent =
  `DATOS ACTUALIZADOS AL D√çA ${fechaMax.toLocaleDateString("es-CL")}`;

  const thead=document.querySelector("thead");
  const tbody=document.querySelector("tbody");
  thead.innerHTML="<tr>"+encabezados.map(h=>`<th data-col="${h}">${h}</th>`).join("")+"</tr>";

  const mesSel=document.getElementById("mesFiltro");
  [...new Set(datos.map(f=>f[IDX.MES]))].forEach(m=>{
    if(!m) return;
    const o=document.createElement("option");
    o.value=o.textContent=m;
    mesSel.appendChild(o);
  });

  const reglasKPI={
    "% FCR 1dia":90,"%FCR 7dia":90,"% Adher General":80,"% Descto":80,"% Rein.":5,"% Ef. BAF":80,
    "% Argumentario":23,"% Oferta":80,"% Adh Capl":25,"%adh Oferta 0":20,"%adh Oferta 1":12,"%adh Oferta 2":23,
    "%adh Oferta 3":55,"% VS Atendidas":90,"% Baja Parc.":4,"% Short Call":5,"% Transf.":10,"% Baja Parc. IPTV":4,"% Corte rac":1
  };
  reglasKPIGlobal=reglasKPI;

  const reglasInvertidas=["% Short Call","% Transf.","% Adh Capl","% Rein.","%adh Oferta 0","% Baja Parc.","% Argumentario","%adh Oferta 1","%adh Oferta 2","%adh Oferta 3","% Baja Parc. IPTV","% Corte rac"];
  reglasInvertidasGlobal=reglasInvertidas;

  function reglaPorColumna(h,v){
    if(!v.includes("%")) return "";
    const n=parseFloat(v.replace("%",""));
    if(isNaN(n)) return "";
    const meta=reglasKPI[h]??85;
    if(reglasInvertidas.includes(h)){
      if(n<=meta) return "kpi-verde";
      if(n<=meta+5) return "kpi-amarillo";
      return "kpi-rojo";
    }
    if(n>=meta) return "kpi-verde";
    if(n>=meta-10) return "kpi-amarillo";
    return "kpi-rojo";
  }

  function render(filtrado){
    datosFiltradosGlobal=filtrado;
    tbody.innerHTML="";
    const frag=document.createDocumentFragment();
    filtrado.forEach(f=>{
      const tr=document.createElement("tr");
      f.forEach((c,i)=>{
        const td=document.createElement("td");
        const kpiClass=reglaPorColumna(encabezados[i],c);
        td.className=kpiClass;

        if(c.includes("%")){
          const n=parseFloat(c.replace("%",""));
          const bar=document.createElement("div");
          bar.className="barra-kpi";
          bar.style.width=n+"%";
          bar.style.background=kpiClass==="kpi-verde"?"#28a745":kpiClass==="kpi-amarillo"?"#ffc107":"#dc3545";
          td.appendChild(bar);
          td.appendChild(document.createTextNode(c));
        }else td.textContent=c;

        tr.appendChild(td);
      });
      frag.appendChild(tr);
    });
    tbody.appendChild(frag);
  }

  function aplicarFiltros(){
    const t=filtro.value.toLowerCase();
    const v=vista.value;
    const m=mesFiltro.value;
    render(datos.filter(f=>{
      if(m && f[IDX.MES]!==m) return false;
      if(v==="dia"){if(!f[IDX.DIA] || f[IDX.DIA].toLowerCase().includes("total")) return false;}
      if(v==="semana" && !f[IDX.SEMANA].includes("Total Semana")) return false;
      if(v==="mes" && !f[IDX.MES].includes("Total")) return false;
      return f.join(" ").toLowerCase().includes(t);
    }));
  }

  filtro.addEventListener("keyup",aplicarFiltros);
  vista.addEventListener("change",aplicarFiltros);
  mesSel.addEventListener("change",aplicarFiltros);
  aplicarFiltros();

  /* =======================
     EXPORTACION EJECUTIVA
  ==========================*/

  document.getElementById("exportarExcel").addEventListener("click",()=>{

    if(datosFiltradosGlobal.length===0){
      alert("No hay datos para exportar");
      return;
    }

    const columnasOcultas=[0,2];
    const encabezadosVisibles=encabezadosGlobal.filter((_,i)=>!columnasOcultas.includes(i));
    const datosVisibles=datosFiltradosGlobal.map(f=>f.filter((_,i)=>!columnasOcultas.includes(i)));

    const wb=XLSX.utils.book_new();

    /* HOJA DETALLE */
    const ws=XLSX.utils.aoa_to_sheet([encabezadosVisibles,...datosVisibles]);
    ws["!freeze"]={xSplit:1,ySplit:1};

    datosVisibles.forEach((row,r)=>{
      row.forEach((cell,c)=>{
        if(cell.includes("%")){
          const val=parseFloat(cell.replace("%",""));
          const ref=XLSX.utils.encode_cell({r:r+1,c:c});
          if(val>=90) ws[ref].s={fill:{fgColor:{rgb:"C6EFCE"}}};
          else if(val>=80) ws[ref].s={fill:{fgColor:{rgb:"FFEB9C"}}};
          else ws[ref].s={fill:{fgColor:{rgb:"FFC7CE"}}};
        }
      });
    });

    XLSX.utils.book_append_sheet(wb,ws,"Detalle KPI");

    /* HOJA RESUMEN */
    const columnasKPIs=encabezadosVisibles.filter(h=>h.includes("%"));
    const resumen=[["KPI","Promedio %"]];

    columnasKPIs.forEach(kpi=>{
      let idx=encabezadosVisibles.indexOf(kpi);
      let valores=datosVisibles.map(r=>parseFloat(r[idx]?.replace("%",""))||0);
      let promedio=(valores.reduce((a,b)=>a+b,0)/valores.length)||0;
      resumen.push([kpi,promedio/100]);
    });

    const wsResumen=XLSX.utils.aoa_to_sheet(resumen);
    for(let i=1;i<resumen.length;i++){
      wsResumen["B"+(i+1)].z="0.00%";
    }

    XLSX.utils.book_append_sheet(wb,wsResumen,"Resumen KPI");

    const hoy=new Date();
    const nombre=`Indicadores_Ejecutivo_${hoy.toISOString().split("T")[0]}.xlsx`;
    XLSX.writeFile(wb,nombre);

  });

});
</script>
</body>
</html>
